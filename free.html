<!DOCTYPE html>
                    });
                })
                .then(uploadResponse => {
                    if (uploadResponse.ok) {
                        uploadMessage.innerHTML = `✅ ဖိုင်ကို အောင်မြင်စွာ တင်ပြီးပါပြီ! (${file.name})`;
                    } else {
                        throw new Error(`R2 Upload Failed: ${uploadResponse.status} ${uploadResponse.statusText}`);
                    }
                })
                .catch(error => {
                    console.error('Final Upload Error:', error);
                    uploadMessage.innerHTML = `❌ Upload မအောင်မြင်ပါ။ Error: ${error.message}`;
                });
        }
        
        // =============================================
        // 4. စာသားကို Server (KV) မှ ဆွဲယူပြီး ပြသခြင်း (Website စဖွင့်သည်နှင့် အလုပ်လုပ်မည်)
        async function fetchInitialText() {
            const mainTextarea = document.getElementById('mainTextArea');
            
            try {
                // GET request ဖြင့် စာသားကို /api/text (Worker) မှ ရယူခြင်း
                const response = await fetch('/api/text'); 
                const text = await response.text();

                // Textarea ထဲသို့ ထည့်သွင်းခြင်း
                mainTextarea.value = text;
            } catch (error) {
                console.error('Failed to fetch initial text:', error);
                mainTextarea.value = 'Data load မလုပ်နိုင်ပါ။ Backend/KV ချိတ်ဆက်မှု စစ်ဆေးပါ။';
            }
        }

        // 5. စာသားကို Server (KV) တွင် သိမ်းဆည်းခြင်း Function (အခြားသူများ မြင်စေရန်)
        async function saveToMainTextarea() {
            const mainTextarea = document.getElementById('mainTextArea');
            const inputLine = document.getElementById('inputLine');
            
            const newText = inputLine.value.trim(); 
            
            if (newText === '') {
                alert('ထည့်သွင်းရန် စာသား မရှိပါ။');
                return;
            }
            
            // လက်ရှိ စာသား (Vmess) နှင့် အသစ်ထည့်သော စာသားကို ပေါင်းစပ်
            const updatedText = mainTextarea.value.trim() + '\n\n' + newText;
            
            // API (POST) ဖြင့် စာသားကို KV တွင် သိမ်းဆည်းခြင်း
            try {
                const response = await fetch('/api/text', {
                    method: 'POST',
                    body: updatedText,
                    headers: { 'Content-Type': 'text/plain' }
                });

                if (!response.ok) {
                    throw new Error('Server error: ' + response.statusText);
                }

                // သိမ်းဆည်းမှု အောင်မြင်ရင် Front-end ကို ပြန်အပ်ဒိတ်
                mainTextarea.value = updatedText; 
                inputLine.value = '';
                alert('✅ စာသားကို အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ။ (အခြားသူများ မြင်နိုင်သည်)');
                mainTextarea.scrollTop = mainTextarea.scrollHeight; 

            } catch (error) {
                alert('❌ သိမ်းဆည်းမှု မအောင်မြင်ပါ။ Error: ' + error.message + '. KV Binding နှင့် /functions/api/text.js ကို စစ်ဆေးပါ။');
                console.error('Save error:', error);
            }
        }
        // =============================================

        // Website စဖွင့်တာနဲ့ စာသားကို တစ်ခါတည်း ဆွဲယူပြီး ပြသရန်
        window.onload = fetchInitialText; 
    </script>
</body> 
</html>
