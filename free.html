
<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free | KP Blog</title>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

        <header>
        <div class="header-content">
            <div class="logo-and-title">
                <img src="images/logo.png" alt="KP Logo" class="logo"> 
                <h1 class="site-title">KP Blog</h1>
            </div>
            
            <nav>
                <a href="index.html">á€™á€°á€œá€…á€¬á€™á€»á€€á€ºá€”á€¾á€¬</a>
                <a href="posts.html">Posts</a>
                <a href="free.html">Free</a>
                
                <a href="buy.html">á€á€šá€ºá€šá€°á€›á€”á€º</a> 
                </nav>
        </div>
    </header>
    <main>
        <div class="card">
            <h2>á€€á€°á€¸á€šá€°á€›á€™á€Šá€·á€º á€…á€¬á€á€¬á€¸á€™á€»á€¬á€¸ / á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€á€±á€¬ á€…á€¬á€á€¬á€¸á€™á€»á€¬á€¸</h2>
            <textarea id="mainTextArea" rows="15" readonly>Loading...</textarea>
        </div>

        <div class="card input-section">
            <h2>á€…á€¬á€á€¬á€¸á€¡á€á€…á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸</h2>
            <input type="text" id="inputLine" placeholder="á€…á€¬á€á€¬á€¸á€¡á€á€…á€º á€‘á€Šá€·á€ºá€›á€”á€º á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€›á€±á€¸á€•á€«á‹..." aria-label="New text input">
            <button onclick="fetchInitialText()">á€…á€¬á€á€¬á€¸ á€€á€°á€¸á€šá€°á€™á€Šá€º</button>
            <button onclick="saveToMainTextarea()">á€…á€¬á€á€¬á€¸á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸/á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸ (Save)</button>
        </div>

        <div class="card upload-section">
            <h2>á€–á€­á€¯á€„á€ºá€á€„á€ºá€›á€”á€º á€”á€±á€›á€¬</h2>
            <p class="description">á€•á€¯á€¶á€™á€»á€¬á€¸áŠ PDF á€™á€»á€¬á€¸ á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€á€„á€º á€€á€¼á€­á€¯á€€á€ºá€”á€¾á€…á€ºá€á€€á€ºá€á€±á€¬ á€–á€­á€¯á€„á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹</p>
            <input type="file" id="fileInput" class="file-input-hidden" onchange="updateFileName(this)">
            <label for="fileInput" class="custom-file-upload">
                <span id="fileNameDisplay">Choose File</span>
            </label>
            <button onclick="startR2Upload()" class="upload-button">âœ…</button>
            <p id="uploadMessage" class="upload-status">Upload status will appear here.</p>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 KP WEBSITE</p>
    </footer>

    <script>
        // File Input á€á€½á€„á€º á€–á€­á€¯á€„á€ºá€”á€¬á€™á€Šá€º á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€›á€”á€º Function
        function updateFileName(input) {
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (input.files.length > 0) {
                fileNameDisplay.textContent = input.files[0].name;
            } else {
                fileNameDisplay.textContent = 'Choose File';
            }
        }

        // =============================================
        // 1. R2 Upload Functions (FIXED)
        async function startR2Upload() {
            const fileInput = document.getElementById('fileInput');
            const uploadMessage = document.getElementById('uploadMessage');
            
            if (fileInput.files.length === 0) {
                uploadMessage.innerHTML = 'âŒ á€–á€­á€¯á€„á€ºá€›á€½á€±á€¸á€á€»á€šá€ºá€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹';
                return;
            }

            const file = fileInput.files[0];
            uploadMessage.innerHTML = `âŒ› ${file.name} á€€á€­á€¯ Upload á€•á€¼á€¯á€œá€¯á€•á€ºá€”á€±á€•á€«á€á€Šá€ºá‹...`;
            
            // Pages Function á€¡á€á€½á€€á€º Absolute Path á€”á€¾á€„á€·á€º Endpoint á€á€á€ºá€™á€¾á€á€º
            const apiEndpoint = "/api/upload"; 

            // Form Data á€¡á€–á€¼á€…á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€•á€¼á€®á€¸ POST request á€–á€¼á€„á€·á€º á€•á€­á€¯á€·á€›á€”á€º
            const formData = new FormData();
            formData.append('file', file); // Server-side (upload.js) á€™á€¾á€¬ 'file' key á€”á€²á€· á€†á€½á€²á€šá€°á€•á€«á€™á€Šá€º

            try {
                // R2 Upload Function á€€á€­á€¯ POST method á€–á€¼á€„á€·á€º á€á€±á€«á€ºá€†á€­á€¯á€á€¼á€„á€ºá€¸
                const uploadResponse = await fetch(apiEndpoint, {
                    method: 'POST', // ğŸ¯ FIX: POST method á€á€¯á€¶á€¸á€á€¼á€„á€ºá€¸
                    body: formData // Form Data á€€á€­á€¯ á€•á€­á€¯á€·á€á€¼á€„á€ºá€¸
                });

                // Server á€€ JSON á€€á€­á€¯ á€•á€¼á€”á€ºá€•á€­á€¯á€·á€™á€¾á€¬ á€–á€¼á€…á€ºá€á€±á€¬á€€á€¼á€±á€¬á€„á€·á€º JSON á€¡á€–á€¼á€…á€º á€–á€á€ºá€á€Šá€º
                const result = await uploadResponse.json(); 

                if (uploadResponse.ok && result.status === 'SUCCESS') {
                    // á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€á€±á€¬ Response á€™á€¾ status 'SUCCESS' á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€á€¼á€„á€ºá€¸
                    uploadMessage.innerHTML = `âœ… á€–á€­á€¯á€„á€ºá€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€„á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®! (${file.name}). Message: ${result.message || ''}`;
                } else {
                    // Server-side error (400, 500) á€™á€»á€¬á€¸á€€á€­á€¯ á€€á€­á€¯á€„á€ºá€á€½á€šá€ºá€á€¼á€„á€ºá€¸
                    throw new Error(`Upload Failed: ${result.message || uploadResponse.statusText}`);
                }
            } catch (error) {
                console.error('Final Upload Error:', error);
                uploadMessage.innerHTML = `âŒ Upload á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹ Error: ${error.message}`;
            }
        }
        
        // =============================================
        // 2. á€…á€¬á€á€¬á€¸á€€á€­á€¯ Server (KV) á€™á€¾ á€†á€½á€²á€šá€°á€•á€¼á€®á€¸ á€•á€¼á€á€á€¼á€„á€ºá€¸ (Website á€…á€–á€½á€„á€·á€ºá€á€Šá€ºá€”á€¾á€„á€·á€º á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€™á€Šá€º)
        async function fetchInitialText() {
            const mainTextarea = document.getElementById('mainTextArea');
            
            try {
                // GET request á€–á€¼á€„á€·á€º á€…á€¬á€á€¬á€¸á€€á€­á€¯ /api/text (Worker) á€™á€¾ á€›á€šá€°á€á€¼á€„á€ºá€¸
                const response = await fetch('/api/text'); 
                const text = await response.text();

                // Textarea á€‘á€²á€á€­á€¯á€· á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸
                mainTextarea.value = text;
            } catch (error) {
                console.error('Failed to fetch initial text:', error);
                mainTextarea.value = 'Data load á€™á€œá€¯á€•á€ºá€”á€­á€¯á€„á€ºá€•á€«á‹ Backend/KV á€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹';
            }
        }

        // 3. á€…á€¬á€á€¬á€¸á€€á€­á€¯ Server (KV) á€á€½á€„á€º á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€á€¼á€„á€ºá€¸ Function (á€¡á€á€¼á€¬á€¸á€á€°á€™á€»á€¬á€¸ á€™á€¼á€„á€ºá€…á€±á€›á€”á€º)
        async function saveToMainTextarea() {
            const mainTextarea = document.getElementById('mainTextArea');
            const inputLine = document.getElementById('inputLine');
            
            const newText = inputLine.value.trim(); 
            
            if (newText === '') {
                alert('á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º á€…á€¬á€á€¬á€¸ á€™á€›á€¾á€­á€•á€«á‹');
                return;
            }
            
            // á€œá€€á€ºá€›á€¾á€­ á€…á€¬á€á€¬á€¸ á€”á€¾á€„á€·á€º á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€á€±á€¬ á€…á€¬á€á€¬á€¸á€€á€­á€¯ á€•á€±á€«á€„á€ºá€¸á€…á€•á€º
            const updatedText = mainTextarea.value.trim() + '\n\n' + newText;
            
            // API (POST) á€–á€¼á€„á€·á€º á€…á€¬á€á€¬á€¸á€€á€­á€¯ KV á€á€½á€„á€º á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€á€¼á€„á€ºá€¸
            try {
                const response = await fetch('/api/text', {
                    method: 'POST',
                    body: updatedText,
                    headers: { 'Content-Type': 'text/plain' }
                });

                if (!response.ok) {
                    throw new Error('Server error: ' + response.statusText);
                }

                // á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€›á€„á€º Front-end á€€á€­á€¯ á€•á€¼á€”á€ºá€¡á€•á€ºá€’á€­á€á€º
                mainTextarea.value = updatedText; 
                inputLine.value = '';
                alert('âœ… á€…á€¬á€á€¬á€¸á€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹ (á€¡á€á€¼á€¬á€¸á€á€°á€™á€»á€¬á€¸ á€™á€¼á€„á€ºá€”á€­á€¯á€„á€ºá€á€Šá€º)');
                mainTextarea.scrollTop = mainTextarea.scrollHeight; 

            } catch (error) {
                alert('âŒ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€™á€¾á€¯ á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹ Error: ' + error.message + '. KV Binding á€”á€¾á€„á€·á€º /functions/api/text.js á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€«á‹');
                console.error('Save error:', error);
            }
        }
        // =============================================

        // Website á€…á€–á€½á€„á€·á€ºá€á€¬á€”á€²á€· á€…á€¬á€á€¬á€¸á€€á€­á€¯ á€á€…á€ºá€á€«á€á€Šá€ºá€¸ á€†á€½á€²á€šá€°á€•á€¼á€®á€¸ á€•á€¼á€á€›á€”á€º
        window.onload = fetchInitialText; 
    </script>
</body> 
</html>
