<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KP Blog Free Page</title>
    <link rel="stylesheet" href="style.css?v=2025102903"> 
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo-and-title">
                <img src="images/logo.png" alt="KP Logo" class="logo"> 
                <h1 class="site-title">KP Blog</h1>
            </div>
            <nav>
                <a href="index.html">မူလစာမျက်နှာ</a>
                <a href="posts.html">Posts</a>
                <a href="free.html">Free</a> 
                <a href="buy.html">ဝယ်ယူရန်</a> 
            </nav>
        </div>
    </header>

    <div class="intro-bar">
       
        <main>
            <section class="posts-section"> </section>
            <h1>KP WEBSITE FREE PAGE</h1>
        
            <div class="text-copy-area copy-box">
                <textarea id="mainTextarea" name="copy_box_title" readonly style="
                    height: 400px;
                    color: white; 
                    background-color: #333; 
                    border: 1px solid #555;
                    font-size: 14px;
                    padding: 15px;
                    margin-bottom: 20px;
                    display: block; 
                    width: 100%; 
                    box-sizing: border-box;
                ">
                    သင် ပေးသွင်းထားသော File/Key တစ်ခုခုပဲ။
                </textarea>
                
                </div>


            <section class="upload-section">
                <h2>ဖိုင်တင်ရန် နေရာ</h2>
                <p>သင်မှာ ရှိသော free File/Key တို့ကို ဤနေရာတွင် ပြန်လည်မျှဝေနိုင်သည်။</p>
                
                <div class="upload-container">
                    <label for="fileInput" class="custom-file-upload">
                        <span id="fileNameDisplay">Choose File</span>
                        <input type="file" id="fileInput" onchange="updateFileName(this)"> 
                    </label>

                    <button onclick="startR2Upload()">
                        <span>✔</span>
                    </button>
                    <div id="uploadMessage" class="upload-status-message">Upload status will appear here.</div>
                </div>
            </section>
            
            <section class="download-list-section" style="margin-top: 50px;">
                <h2>⬇️ ဖိုင်စာရင်း (Download)</h2>
                <p>ဖိုင်များအားလုံးကို ဤနေရာတွင် ကြည့်ရှုနိုင်ပါသည်။</p>
                
                <iframe 
                    id="r2-file-list-iframe" 
                    src="/api/r2-list" 
                    style="width: 100%; min-height: 500px; border: 1px solid #ccc; border-radius: 8px; margin-top: 15px;" 
                    frameborder="0">
                </iframe>
            </section>
        </main>
    </div>
    
    <footer>
        <p>&copy; 2025 KP WEBSITE</p>
    </footer>

    <script>
        // HTML element များကို ရယူခြင်း
        const mainTextarea = document.getElementById('mainTextarea'); 
        
        // 1. File Name Display Function (မူရင်းအတိုင်း)
        function updateFileName(input) {
            var fileName = input.files[0] ? input.files[0].name : "Choose File";
            document.getElementById('fileNameDisplay').innerText = fileName;
        }
        
        // =====================================
         // R2 Upload Functions (ယခင်အတိုင်း ထားရှိပါသည်)
        async function startR2Upload() {
            const fileInput = document.getElementById('fileInput');
            const uploadMessage = document.getElementById('uploadMessage');
            
            if (fileInput.files.length === 0) {
                uploadMessage.innerHTML = '❌ ဖိုင်ရွေးချယ်ရန် လိုအပ်ပါသည်။';
                return;
            }

            const file = fileInput.files[0];
            uploadMessage.innerHTML = `⌛ ${file.name} ကို Upload ပြုလုပ်နေပါသည်။...`;
            
            const apiEndpoint = "/api/upload"; 

            const formData = new FormData();
            formData.append('file', file); 

            try {
                const uploadResponse = await fetch(apiEndpoint, {
                    method: 'POST', 
                    body: formData 
                });

                const result = await uploadResponse.json(); 

                if (uploadResponse.ok && result.status === 'SUCCESS') {
                    uploadMessage.innerHTML = `✅ ဖိုင်ကို အောင်မြင်စွာ တင်ပြီးပါပြီ! (${file.name}). Message: ${result.message}`;
                    const iframe = document.getElementById('r2-file-list-iframe');
                    if (iframe) {
                        // iframe ကို အောင်မြင်စွာ Refresh လုပ်ခြင်း
                        iframe.src = iframe.src; 
                    }
                } else {
                    const errorText = result.message || uploadResponse.statusText;
                    uploadMessage.innerHTML = `❌ Upload မအောင်မြင်ပါ။ Error: ${errorText}`;
                    throw new Error(`Upload Failed: ${errorText}`);
                }
            } catch (error) {
                console.error('Final Upload Error:', error);
                uploadMessage.innerHTML = `❌ Upload မအောင်မြင်ပါ။ Error: ${error.message}`;
            }
        }
        // =============================================
        // 4. စာသားကို Server (KV) မှ ဆွဲယူပြီး ပြသခြင်း (Textarea အတွက်)
        async function fetchInitialText() {
            try {
                const response = await fetch('/api/text'); 
                const text = await response.text();
                mainTextarea.value = text;
            } catch (error) {
                console.error('Failed to fetch initial text:', error);
                mainTextarea.value = 'Data load မလုပ်နိုင်ပါ။ Backend/KV ချိတ်ဆက်မှု စစ်ဆေးပါ။';
            }
        }

        // 5. saveToMainTextarea Function ကို ဖယ်ရှားလိုက်ပါပြီ။
        
        // Website စဖွင့်တာနဲ့ စာသားကို တစ်ခါတည်း ဆွဲယူပြီး ပြသရန်
        document.addEventListener('DOMContentLoaded', fetchInitialText);
    </script>
</body>
</html>
