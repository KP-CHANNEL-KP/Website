<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KP Blog Free Page</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo-and-title">
                <img src="images/logo.png" alt="KP Logo" class="logo"> 
                <h1 class="site-title">KP Blog</h1>
            </div>
            <nav>
                <a href="index.html">မူလစာမျက်နှာ</a>
                <a href="posts.html">Posts</a>
                <a href="free.html">Free</a> 
                <a href="buy.html">ဝယ်ယူရန်</a> 
            </nav>
        </div>
    </header>

    <div class="intro-bar">
       
        <main>
        <section class="posts-section"> </section>
        <h1>KP WEBSITE FREE PAGE</h1>
        
        <div class="copy-box">
            <p class="copy-box-title">ကူးယူရန် စာသားများ / သင်ထည့်သွင်းသော စာများ:</p> 
            <textarea id="mainTextArea" class="big-textarea" 
                rows="20" readonly 
                placeholder="စာသားများ ဤနေရာတွင် ပေါ်လာပါမည်။ (Scroll လုပ်နိုင်သည်)">
                Loading...
            </textarea>
            
            <p class="copy-box-title" style="margin-top: 15px;">စာသားအသစ် ထည့်သွင်းရန်:</p>
            <input type="text" id="inputLine" class="small-input-line" 
                   placeholder="စာသားအသစ် ထည့်ရန် ဤနေရာတွင် ရေးပါ...">
            
            <button onclick="copyToClipboard('mainTextArea')" class="copy-button" style="margin-bottom: 10px;">
                စာသား ကူးယူမည်
            </button>

            <button id="saveButton" onclick="saveToMainTextarea()" class="save-button">
                စာသားထည့်သွင်း/သိမ်းဆည်း (Save)
            </button>
        </div>
        <section class="upload-section">
            <h2>ဖိုင်တင်ရန် နေရာ</h2>
            <p>ပုံများ၊ PDF များ သို့မဟုတ် သင်ကြိုက်နှစ်သက်သော ဖိုင်များကို ဤနေရာတွင် တင်နိုင်ပါသည်။</p>
            
            <div class="upload-container">
                <label for="r2FileInput" class="custom-file-upload">
                    <span id="fileNameDisplay">Choose File</span>
                    <input type="file" id="r2FileInput" onchange="updateFileName(this)"> 
                </label>

                <button onclick="startR2Upload()">
                    <span>✔</span>
                </button>
                <div id="uploadMessage" class="upload-status-message">Upload status will appear here.</div>
            </div>
        </section>
        </main>
    </div>

    <script>
        // 1. Copy Function 
        function copyToClipboard(elementId) {
            var copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            document.execCommand("copy");
            alert("စာသား ကူးယူပြီးပါပြီ!"); 
        }

        // 2. File Name Display Function
        function updateFileName(input) {
            var fileName = input.files[0] ? input.files[0].name : "Choose File";
            document.getElementById('fileNameDisplay').innerText = fileName;
        }

        // 3. R2 Upload Function (မူရင်း Code)
        function startR2Upload() {
            const fileInput = document.getElementById('r2FileInput');
            const uploadMessage = document.getElementById('uploadMessage');
            const file = fileInput.files[0];

            if (!file) {
                uploadMessage.innerHTML = '❌ ဖိုင်ကို ရွေးချယ်ပေးပါဦး။';
                return;
            }

            uploadMessage.innerText = 'ဖိုင်တင်နေပါသည်...'; 

            const fileType = encodeURIComponent(file.type || 'application/octet-stream'); 
            const apiEndpoint = '/upload-url?fileName=' + file.name + '&fileType=' + fileType;

            fetch(apiEndpoint)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`API Call Failed. Status: ${response.status}. Response: ${text.substring(0, 50)}...`);
                        });
                    }
                    return response.json(); 
                })
                .then(data => {
                    const signedUrl = data.uploadURL; 
                    
                    // R2 သို့ ဖိုင်ကို တိုက်ရိုက် တင်ခြင်း (POST Request)
                    return fetch(signedUrl, {
                        method: 'POST',
                        body: file,
                        headers: {
                            'Content-Type': file.type || 'application/octet-stream'
                        }
                    });
                })
                .then(uploadResponse => {
                    if (uploadResponse.ok) {
                        uploadMessage.innerHTML = `✅ ဖိုင်ကို အောင်မြင်စွာ တင်ပြီးပါပြီ! (${file.name})`;
                    } else {
                        throw new Error(`R2 Upload Failed: ${uploadResponse.status} ${uploadResponse.statusText}`);
                    }
                })
                .catch(error => {
                    console.error('Final Upload Error:', error);
                    uploadMessage.innerHTML = `❌ Upload မအောင်မြင်ပါ။ Error: ${error.message}`;
                });
        }
        
        // =============================================
        // 4. စာသားကို Server (KV) မှ ဆွဲယူပြီး ပြသခြင်း (Website စဖွင့်သည်နှင့် အလုပ်လုပ်မည်)
        async function fetchInitialText() {
            const mainTextarea = document.getElementById('mainTextArea');
            
            try {
                // GET request ဖြင့် စာသားကို /api/text (Worker) မှ ရယူခြင်း
                const response = await fetch('/api/text'); 
                const text = await response.text();

                // Textarea ထဲသို့ ထည့်သွင်းခြင်း
                mainTextarea.value = text;
            } catch (error) {
                console.error('Failed to fetch initial text:', error);
                mainTextarea.value = 'Data load မလုပ်နိုင်ပါ။ Backend/KV ချိတ်ဆက်မှု စစ်ဆေးပါ။';
            }
        }

        // 5. စာသားကို Server (KV) တွင် သိမ်းဆည်းခြင်း Function (အခြားသူများ မြင်စေရန်)
        async function saveToMainTextarea() {
            const mainTextarea = document.getElementById('mainTextArea');
            const inputLine = document.getElementById('inputLine');
            
            const newText = inputLine.value.trim(); 
            
            if (newText === '') {
                alert('ထည့်သွင်းရန် စာသား မရှိပါ။');
                return;
            }
            
            // လက်ရှိ စာသား (Vmess) နှင့် အသစ်ထည့်သော စာသားကို ပေါင်းစပ်
            const updatedText = mainTextarea.value.trim() + '\n\n' + newText;
            
            // API (POST) ဖြင့် စာသားကို KV တွင် သိမ်းဆည်းခြင်း
            try {
                const response = await fetch('/api/text', {
                    method: 'POST',
                    body: updatedText,
                    headers: { 'Content-Type': 'text/plain' }
