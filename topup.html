<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KP Top Up â€¢ Login á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€º</title>
    <meta name="description" content="KP Top Up - Google á€–á€¼á€„á€·á€º á€á€„á€ºá€›á€±á€¬á€€á€ºá€•á€¼á€®á€¸ á€œá€¯á€¶á€á€¼á€¯á€¶á€…á€­á€á€ºá€á€»á€…á€½á€¬ á€á€šá€ºá€šá€°á€•á€«">

    <meta name="google-signin-client_id" content="745888739692-gq8h4f6tjcr35d7ttmce4vg6d03of5tp.apps.googleusercontent.com">
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        :root {--primary:#00ff9d;--primary-dark:#00cc7a;--bg:#0d0d1f;--card:rgba(20,25,50,0.8);--text:#e0e0ff;--border:rgba(0,255,157,0.3);}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Pyidaungsu',sans-serif;background:linear-gradient(135deg,#0d0d1f,#1a1a2e);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;background-attachment:fixed;}
        .login-box{background:var(--card);backdrop-filter:blur(15px);border-radius:20px;padding:40px;width:90%;max-width:420px;text-align:center;border:1px solid var(--border);box-shadow:0 20px 50px rgba(0,0,0,0.6);}
        .logo img{height:80px;border-radius:20px;border:3px solid var(--primary);margin-bottom:20px;}
        h1{font-size:2.5em;background:linear-gradient(90deg,#00ff9d,#00ccff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:20px;}
        p{font-size:1.1em;margin:20px 0;color:#bbb;}
        .google-btn{margin:30px auto;width:80%;}
        .hidden{display:none;}
        footer{position:fixed;bottom:20px;color:#666;font-size:0.9em;left:0;right:0;text-align:center;}
    </style>
</head>
<body>

<div class="login-box" id="loginBox">
    <div class="logo"><img src="images/logo.png" alt="KP Logo"></div>
    <h1>KP Top Up</h1>
    <p>á€œá€¯á€¶á€á€¼á€¯á€¶á€…á€­á€á€ºá€á€»á€…á€½á€¬ á€á€šá€ºá€šá€°á€›á€”á€º<br><strong>Google á€–á€¼á€„á€·á€º á€á€„á€ºá€›á€±á€¬á€€á€ºá€•á€«</strong></p>
    <div id="googleSignIn" class="google-btn"></div>
    <p style="margin-top:30px;color:#ff6b6b;font-size:0.95em;">á€œá€­á€™á€ºá€Šá€¬á€á€°á€™á€»á€¬á€¸á€€á€­á€¯ á€á€»á€€á€ºá€á€»á€„á€ºá€¸ Ban á€œá€¯á€•á€ºá€•á€«á€™á€Šá€º!</p>
</div>

<div id="topupPage" class="hidden"></div>

<footer>Â© 2025 KP Blog â€¢ á€œá€¯á€¶á€á€¼á€¯á€¶á€›á€±á€¸ á€¡á€™á€¼á€„á€·á€ºá€†á€¯á€¶á€¸</footer>

<script>
const GOOGLE_CLIENT_ID = "745888739692-gq8h4f6tjcr35d7ttmce4vg6d03of5tp.apps.googleusercontent.com";
let currentUser = null;

// Helper function to safely decode the JWT payload
function decodeJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch (e) {
        console.error("JWT Decode Error:", e);
        return null;
    }
}

// ğŸ”‘ á€¡á€›á€±á€¸á€€á€¼á€®á€¸á€†á€¯á€¶á€¸ á€•á€¼á€„á€ºá€†á€„á€ºá€á€»á€€á€º- GSI á€¡á€á€…á€ºá€›á€²á€· Callback á€€á€­á€¯á€á€¯á€¶á€¸á€á€¼á€„á€ºá€¸
window.handleCredentialResponse = function(response) {
    const profile = decodeJwt(response.credential);

    if (!profile || !profile.email) {
        console.error("Sign-in failed or profile data is missing in token.");
        alert("Google Sign In á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«áŠ Console á€€á€­á€¯á€…á€…á€ºá€†á€±á€¸á€•á€«á‹ (Token data á€™á€›á€•á€«)");
        return;
    }

    // Modern GSI token fields
    currentUser = {
        name: profile.name,
        email: profile.email,
        id: profile.sub, // 'sub' is the unique Google User ID
        photo: profile.picture
    };

    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("topupPage").classList.remove("hidden");
    loadTopUpPage();
};

function loadTopUpPage() {
    document.getElementById("topupPage").innerHTML = `
    <header style="position:fixed;top:0;left:0;right:0;background:rgba(10,10,30,0.95);backdrop-filter:blur(15px);z-index:1000;padding:15px 20px;border-bottom:1px solid var(--border);">
        <div style="max-width:1400px;margin:auto;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;align-items:center;gap:15px;">
                <img src="${currentUser.photo}" width="50" height="50" style="border-radius:50%;border:3px solid var(--primary);">
                <div style="color:white;">
                    <div style="font-weight:bold;color:var(--primary);">${currentUser.name}</div>
                    <div style="font-size:0.9em;color:#aaa;">${currentUser.email}</div>
                </div>
            </div>
            <div style="color:#ff6b6b;font-size:0.9em;">á€œá€­á€™á€ºá€Šá€¬á€•á€«á€€ á€á€»á€€á€ºá€á€»á€„á€ºá€¸ Ban á€œá€¯á€•á€ºá€•á€«á€™á€Šá€º</div>
        </div>
    </header>

    <main style="margin-top:100px;padding:20px;max-width:1000px;margin:auto;">
        <h1 style="text-align:center;font-size:3em;margin:30px 0;background:linear-gradient(90deg,#00ff9d,#00ccff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">KP Top Up Center</h1>

        <div style="background:var(--card);backdrop-filter:blur(12px);border-radius:20px;padding:30px;border:1px solid var(--border);box-shadow:0 15px 40px rgba(0,0,0,0.4);">
            <label>á€‚á€­á€™á€ºá€¸á€›á€½á€±á€¸á€•á€«</label>
            <select id="game"><option value="pubg">PUBG Mobile</option><option value="ml">Mobile Legends</option></select>

            <label>User ID (á€”á€¶á€•á€«á€á€º á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º (á€”á€¶á€•á€«á€á€º))</label>
            <input type="text" id="userId" placeholder="á€¥á€•á€™á€¬: 5123456789 á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º (5123456789)" oninput="this.value=this.value.replace(/[^\\d()]/g,'')">

            <label>á€„á€½á€±á€œá€½á€¾á€²á€•á€¼á€±á€…á€¬ á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ á… á€œá€¯á€¶á€¸</label>
            <input type="text" id="refNumber" maxlength="7" placeholder="á€¥á€•á€™á€¬: 54321 á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º (54321)" oninput="this.value=this.value.replace(/[^\\d()]/g,'')" style="letter-spacing:5px;font-weight:bold;">

            <div style="font-size:1.3em;margin:25px 0;color:var(--primary);text-align:center;">
                <span id="gameName">PUBG Mobile</span> á€¡á€á€½á€€á€º á€•á€™á€¬á€ á€›á€½á€±á€¸á€•á€«
            </div>

            <div id="packages" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin:30px 0;"></div>

            <div style="display:flex;justify-content:center;gap:30px;margin:30px 0;flex-wrap:wrap;">
                <div class="pay active" data-pay="wave" style="text-align:center;cursor:pointer;">
                    <img src="images/wave.png" width="80" height="80" style="border-radius:15px;border:3px solid var(--primary);"><br>Wave Pay
                </div>
                <div class="pay" data-pay="kpay" style="text-align:center;cursor:pointer;">
                    <img src="images/kpay.png" width="80" height="80" style="border-radius:15px;border:3px solid transparent;"><br>KPay
                </div>
            </div>

            <div style="text-align:center;margin:20px 0;color:#ff6b6b;font-size:1.2em;">
                á€„á€½á€±á€œá€½á€¾á€²á€•á€¼á€®á€¸á€™á€¾ á€¡á€±á€¬á€€á€ºá€€ á€á€œá€¯á€•á€ºá€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€«<br>
                <strong>Wave/KPay: 09966955081</strong>
            </div>

            <button onclick="submitOrder()" style="width:100%;padding:20px;background:linear-gradient(45deg,var(--primary),var(--primary-dark));color:black;font-weight:bold;font-size:1.5em;border-radius:50px;border:none;cursor:pointer;box-shadow:0 10px 30px rgba(0,255,157,0.5);">
                á€¡á€á€Šá€ºá€•á€¼á€¯á€•á€¼á€®á€¸ á€™á€¾á€¬á€šá€°á€™á€Šá€º
            </button>
            <button id="loadingBtn" style="display:none;width:100%;padding:20px;background:#555;color:white;font-size:1.5em;border-radius:50px;border:none;" disabled>á€•á€­á€¯á€·á€”á€±á€•á€«á€á€Šá€º...</button>
        </div>
    </main>`;

    // Packages & Submit Logic (unchanged from the final working version)
    const packages = {pubg:[{name:"60 UC",price:"1000 á€€á€»á€•á€º"},{name:"325 UC",price:"5000 á€€á€»á€•á€º"},{name:"600 UC",price:"9000 á€€á€»á€•á€º"},{name:"1800 UC",price:"25000 á€€á€»á€•á€º"},{name:"3850 UC",price:"50000 á€€á€»á€•á€º"}],
        ml:[{name:"86 Diamonds",price:"3000 á€€á€»á€•á€º"},{name:"172 Diamonds",price:"5500 á€€á€»á€•á€º"},{name:"257 Diamonds",price:"8000 á€€á€»á€•á€º"},{name:"344 Diamonds",price:"10500 á€€á€»á€•á€º"},{name:"706 Diamonds",price:"21000 á€€á€»á€•á€º"}]};
    let selectedPkg = packages[document.getElementById("game").value][0];
    let selectedPay = "wave";

    function loadPackages() {
        const game = document.getElementById("game").value;
        document.getElementById("gameName").textContent = game === "pubg" ? "PUBG Mobile" : "Mobile Legends";
        const container = document.getElementById("packages");
        container.innerHTML = "";
        
        const currentPackages = packages[game];

        currentPackages.forEach((p,i)=>{
            const div = document.createElement("div");
            div.className = "pkg"+(i===0?" active":"");
            div.innerHTML = `<h3>${p.name}</h3><p>${p.price}</p>`; 
            div.style.cssText = "background:rgba(0,255,157,0.15);border:2px solid var(--primary);border-radius:15px;padding:20px;text-align:center;cursor:pointer;transition:0.4s;h3{font-size:1.6em;margin:10px 0;}";

            if (i === 0) {
                 div.style.cssText += "background:var(--primary);color:#000;transform:translateY(-10px);box-shadow:0 15px 30px rgba(0,255,157,0.4);";
            }
            
            div.onclick = ()=>{ 
                document.querySelectorAll("#packages .pkg").forEach(e => {
                    e.classList.remove("active");
                    e.style.cssText = "background:rgba(0,255,157,0.15);border:2px solid var(--primary);border-radius:15px;padding:20px;text-align:center;cursor:pointer;transition:0.4s;";
                });
                
                div.classList.add("active");
                div.style.cssText = "background:var(--primary);color:#000;transform:translateY(-10px);box-shadow:0 15px 30px rgba(0,255,157,0.4);border:2px solid var(--primary);border-radius:15px;padding:20px;text-align:center;cursor:pointer;transition:0.4s;";

                selectedPkg=p; 
            };
            if(i===0) selectedPkg=p;
            container.appendChild(div);
        });
        
        document.querySelectorAll(".pay").forEach(p => {
             const img = p.querySelector("img");
             if (p.classList.contains("active")) {
                img.style.borderColor = "var(--primary)";
                img.style.boxShadow = "0 0 20px rgba(0,255,157,0.6)";
             } else {
                 img.style.borderColor = "transparent";
                 img.style.boxShadow = "none";
             }
         });
    }

    loadPackages();
    document.getElementById("game").onchange = loadPackages;

    document.querySelectorAll(".pay").forEach(p => {
        p.onclick = () => {
            document.querySelectorAll(".pay").forEach(e => { 
                const img = e.querySelector("img");
                img.style.borderColor = "transparent"; 
                img.style.boxShadow = "none";
                e.classList.remove("active"); 
            });
            
            const img = p.querySelector("img");
            img.style.borderColor = "var(--primary)";
            img.style.boxShadow = "0 0 20px rgba(0,255,157,0.6)";
            p.classList.add("active");
            selectedPay = p.dataset.pay;
        };
    });

    window.submitOrder = async function() {
        let userId = document.getElementById("userId").value.trim();
        let refNumber = document.getElementById("refNumber").value.trim();
        const cleanId = userId.replace(/[()]/g,'');
        const cleanRef = refNumber.replace(/[()]/g,'');
        
        if(!cleanId || !selectedPkg || cleanRef.length!==5){
            alert("á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ á€™á€¾á€”á€ºá€€á€”á€ºá€…á€½á€¬ á€–á€¼á€Šá€·á€ºá€•á€±á€¸á€•á€«á‹");
            return;
        }

        document.querySelector("button[onclick='submitOrder()']").style.display="none";
        document.getElementById("loadingBtn").style.display="block";

        const message = `
*KP Top Up á€™á€¾á€¬á€šá€°á€™á€¾á€¯ á€¡á€á€…á€º* (á€œá€¯á€¶á€á€¼á€¯á€¶á€…á€”á€…á€º)

*á€á€šá€ºá€á€° á€¡á€á€»á€€á€ºá€¡á€œá€€á€º*
á€¡á€™á€Šá€º: ${currentUser.name}
á€¡á€®á€¸á€™á€±á€¸á€œá€º: ${currentUser.email}
Google ID (Ban á€œá€¯á€•á€ºá€›á€”á€º): ${currentUser.id}

á€‚á€­á€™á€ºá€¸: ${document.getElementById("game").options[document.getElementById("game").selectedIndex].text}
User ID: ${userId}
á€•á€™á€¬á€: ${selectedPkg.name}
á€ˆá€±á€¸á€”á€¾á€¯á€”á€ºá€¸: ${selectedPkg.price}
á€„á€½á€±á€•á€±á€¸á€á€»á€±á€”á€Šá€ºá€¸: ${selectedPay === "wave" ? "Wave Pay" : "KPay"}
á€„á€½á€±á€œá€½á€¾á€²á€•á€¼á€±á€…á€¬ á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ á… á€œá€¯á€¶á€¸: ${refNumber}

á€¡á€á€»á€­á€”á€º: ${new Date().toLocaleString("my-MM")}
        `;

        try {
            await fetch("https://api.telegram.org/bot8565432520:AAFbW60KA7GUXuTx_MQJNT_iFEWr73lHvm8/sendMessage", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({chat_id:7070690379, text:message, parse_mode:"Markdown"})
            });
            alert("á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€•á€­á€¯á€·á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®!\nAdmin á€€ á€™á€€á€¼á€¬á€á€„á€º á€‘á€Šá€·á€ºá€•á€±á€¸á€•á€«á€™á€Šá€ºá‹");
        } catch(e) {
            alert("á€¡á€„á€ºá€á€¬á€”á€€á€ºá€•á€¼á€¿á€”á€¬ á€›á€¾á€­á€”á€±á€•á€«á€á€Šá€ºá‹");
        }

        document.querySelector("button[onclick='submitOrder()']").style.display="block";
        document.getElementById("loadingBtn").style.display="none";
    };
}

// Google Sign-In Button á€‘á€Šá€·á€ºá€•á€±á€¸á€á€šá€º
window.onload = () => {
    google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse // ğŸ”‘ Callback function á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€œá€­á€¯á€€á€ºá€á€¼á€„á€ºá€¸
    });
    google.accounts.id.renderButton(
        document.getElementById("googleSignIn"),
        { theme: "outline", size: "large", text: "signin_with", width: "300", logo_alignment: "left" }
    );
    google.accounts.id.prompt();
};
</script>

</body>
</html>
